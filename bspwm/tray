#! /bin/sh

#VPN variables
VPN_IF=azirevpn
VPN_CHECK="curl -s https://api.azirevpn.com/v1/check --connect-timeout 5 | grep '\"connected\": true'"
POLL_DELAY=0

while true ; do
	#Process states

	PS=$(ps -cax)

	##Telegram state

	TELEGRAM_PID=$(echo "$PS" | grep telegram-desk | awk '{ print $1 }')

	if [[ $TELEGRAM_PID && !$TELEGRAM_WID ]] ; then
		WIDS=$(xdotool search --pid ${TELEGRAM_PID})
		TELEGRAM_WID=$(for WID in $WIDS ; do xwininfo -id $WID | grep '"Telegram' | awk '{ print $4 }' ; done)
	elif [[ !$TELEGRAM_PID ]] ; then
		unset TELEGRAM_WID
	fi

	if [[ $TELEGRAM_WID ]] ; then
		TELEGRAM="%{T3}\uf1d8%{T-} $(xprop -id $TELEGRAM_WID WM_NAME | tr -dc '0-9')  "
	else
		unset TELEGRAM
	fi

	##Dropbox state

	DROPBOX_RUN=$(echo "$PS" | grep dropbox)

	if [[ $DROPBOX_RUN ]] ; then
		DROPBOX_STATE=$(dropbox-cli status)
	fi

	if [[ $DROPBOX_STATE == "Up to date" ]] ; then
		DROPBOX="\uf16b  "
	elif [[ $DROPBOX_RUN ]] ; then
		DROPBOX="\uf16b !  "
	else
		unset DROPBOX
	fi

	##Redshift state

	REDSHIFT_RUN=$(echo "$PS" | grep redshift)

	if [[ $REDSHIFT_RUN ]] ; then
		REDSHIFT="\uf0eb  "
	else
		REDSHIFT="%{F#FF707880}\uf0eb%{F-}  "
	fi

	#Network interface state(s)

	##Set network icon variable(s)

	NIFS=$(ls -r /sys/class/net | grep '^e\|^w')

	for NIF in $NIFS ; do

		case ${NIF:0:1} in
			"e")
				eval ${NIF}_ICON="uf0e8"
				;;
			"w")
				eval ${NIF}_ICON="uf1eb"
				;;
		esac

	done

	##Print network interface state(s)

	unset NET
	IP=$(ip r)

	for NIF in $NIFS ; do
		NET_UP=$(echo "$IP" | grep $NIF)

		if [[ $NET_UP ]] ; then
			NET+=$(eval echo "'\'\$${NIF}_ICON")
			NET+="  "
		else
			NET+=$(eval echo "%{F#FF707880}'\'\$${NIF}_ICON%{F-}")
			NET+="  "
		fi

	done

	##VPN state

	VPN_UP=$(echo "$IP" | grep ${VPN_IF})

	if [[ $VPN_UP && $POLL_DELAY == 1 ]] ; then
		VPN_CONNECTED=$(eval ${VPN_CHECK})
	fi

	POLL_DELAY=$(((POLL_DELAY + 1) % 10))

	if [[ $VPN_UP && $VPN_CONNECTED ]] ; then
		VPN="\uf023  "
	elif [[ $VPN_UP ]] ; then
		VPN="%{F#FFCC6666}\uf023%{F-}  "
	else
		VPN="\uf09c  "
	fi

	#Pulseaudio volume

	VOLUME=$(~/.config/bspwm/volume_poll)

	echo -e "R$TELEGRAM$DROPBOX$REDSHIFT$VPN$NET"
	echo -e "$VOLUME"

	sleep 1
done > "$PANEL_FIFO" &
