#! /bin/zsh

#Set machine-specific network variables

if [[ $(hostname) == 'hathor' ]]
then
	INTERFACE=wlo1
	NSYM="\uf25c"
else
	INTERFACE=enp4s0
	NSYM="\uf341"
fi

while true;
do
	PS=$(ps -cax)
	
	#Telegram state

	TELEGRAM_RUN=$(echo $PS | grep telegram)
	if [[ $TELEGRAM_RUN ]]
	then
		TELEGRAM_MES=$(xdotool search --class "TelegramDesktop" getwindowname | tr -dc '0-9')
	fi
	if [[ $TELEGRAM_MES ]]
	then
		TELEGRAM="\uf1d8 $TELEGRAM_MES  "
		TELEGRAM_MES=""
	elif [[ $TELEGRAM_RUN && !$TELEGRAM_MES ]]
	then
		TELEGRAM="\uf1d8  "
	else
		TELEGRAM=""
	fi

	#Dropbox state

	DROPBOX_RUN=$(echo $PS | grep dropbox)
	if [[ $DROPBOX_RUN ]]
	then
		DROPBOX_STATE=$(dropbox-cli status)
	fi
	if [[ $DROPBOX_STATE == "Up to date" ]]
	then
		DROPBOX="\uf16b  "
	elif [[ $DROPBOX_RUN && $DROPBOX_STATE != "Up to date" ]]
	then
		DROPBOX="\uf16b !  "
	else
		DROPBOX=""
	fi

	#Redshift state

	REDSHIFT_RUN=$(echo $PS | grep redshift)
	if [[ $REDSHIFT_RUN ]]
	then
		REDSHIFT="\uf0eb  "
	else
		REDSHIFT="%{F#FF707880}\uf0eb%{F-}  "
	fi

	#Network and VPN states

	IP=$(ip r)

	VPN_UP=$(echo $IP | grep tun0)
	if [[ $VPN_UP ]]
	then
		VPN="\uf023  "
	else
		VPN="\uf09c  "
	fi

	NET_UP=$(echo $IP | grep $INTERFACE) 
	if [[ $NET_UP ]]
	then
		NET="%{T3}$NSYM%{T-}  "
	else
		NET="%{T3}%{F#FF707880}$NSYM%{F-}%{T-}  "
	fi
	
	echo "R$TELEGRAM$DROPBOX$REDSHIFT$VPN$NET"

	sleep 1
done > "$PANEL_FIFO" &
